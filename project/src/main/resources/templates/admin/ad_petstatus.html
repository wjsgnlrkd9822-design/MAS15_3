<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ê´€ë¦¬ì | ë°˜ë ¤ê²¬ ìƒíƒœ ê´€ë¦¬</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <!-- CSRF í† í° -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            background-color: #f5f6f7;
        }
        .sidebar {
            width: 240px;
            background-color: #1f2933;
            color: #fff;
        }
        .sidebar h5 {
            font-weight: 600;
        }
        .sidebar .nav-link {
            color: #cbd5e1;
            padding: 10px 14px;
            border-radius: 6px;
        }
        .sidebar .nav-link.active,
        .sidebar .nav-link:hover {
            background-color: #374151;
            color: #fff;
        }
        .header {
            background: #ffffff;
            border-bottom: 1px solid #e5e7eb;
        }
        
        /* ìƒíƒœ ë±ƒì§€ ìŠ¤íƒ€ì¼ */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-resting {
            background: #e3f2fd;
            color: #1976d2;
        }
        .status-playing {
            background: #fff3e0;
            color: #f57c00;
        }
        .status-eating {
            background: #ffebee;
            color: #d32f2f;
        }
        .status-walking {
            background: #e8f5e9;
            color: #388e3c;
        }
        .status-none {
            background: #f5f5f5;
            color: #757575;
        }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        /* í…Œì´ë¸” í˜¸ë²„ */
        .table tbody tr:hover {
            background-color: #f8f9fa;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div class="d-flex">

    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar p-4 vh-100">
        <h5 class="mb-4">ê´€ë¦¬ì í˜ì´ì§€</h5>
        <nav class="nav flex-column gap-1">
            <a class="nav-link" th:href="@{/admin}">ğŸ“Š ë§¤ì¶œ ì¡°íšŒ</a>
            <a class="nav-link" th:href="@{/admin/usermanage}">ğŸ‘¥ íšŒì› ê´€ë¦¬</a>
            <a class="nav-link" th:href="@{/admin/service}">âš™ï¸ ì„œë¹„ìŠ¤ ë° ì‹œì„¤ ê´€ë¦¬</a>
            <a class="nav-link" th:href="@{/admin/trainer}">ğŸ‡ í›ˆë ¨ì‚¬ ê´€ë¦¬</a>
            <a class="nav-link" th:href="@{/admin/notice}">ğŸ“ ê³µì§€ì‚¬í•­</a>
            <a class="nav-link" th:href="@{/admin/petstatus}">ğŸ¾ ë°˜ë ¤ê²¬ ìƒíƒœ ê´€ë¦¬</a>
        </nav>
    </aside>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <main class="flex-fill">

        <!-- í—¤ë” -->
        <header class="header px-4 py-3">
            <h4 class="mb-0 fw-semibold">
                <i class="fa-solid fa-paw text-primary"></i>
                ë°˜ë ¤ê²¬ ìƒíƒœ ê´€ë¦¬
            </h4>
        </header>

        <!-- ì½˜í…ì¸  -->
        <section class="p-4">

            <div class="mb-4">
                <p class="text-muted mb-0">í˜„ì¬ ì²´í¬ì¸ ì¤‘ì¸ ë°˜ë ¤ê²¬ì˜ ìƒíƒœë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</p>
            </div>

            <!-- í†µê³„ ì¹´ë“œ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <p class="text-muted mb-1">ì´ ì²´í¬ì¸</p>
                                    <h3 class="mb-0" id="totalCount">0</h3>
                                </div>
                                <i class="fa-solid fa-dog fs-1 text-primary opacity-25"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ë°˜ë ¤ê²¬ ëª©ë¡ í…Œì´ë¸” -->
            <div class="card shadow-sm">
                <div class="card-header bg-white py-3">
                    <h5 class="mb-0">
                        <i class="fa-solid fa-list"></i>
                        í˜„ì¬ ì²´í¬ì¸ ì¤‘ì¸ ë°˜ë ¤ê²¬
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>ë°˜ë ¤ê²¬ëª…</th>
                                    <th>ê²¬ì¢…/í¬ê¸°</th>
                                    <th>ë³´í˜¸ì</th>
                                    <th>ê°ì‹¤</th>
                                    <th>ì²´í¬ì¸ ~ ì²´í¬ì•„ì›ƒ</th>
                                    <th>í˜„ì¬ ìƒíƒœ</th>
                                    <th>ë‹¤ìŒ ì¼ì •</th>
                                    <th>ê´€ë¦¬</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- ë°ì´í„°ê°€ ìˆì„ ë•Œ -->
                                <th:block th:if="${petList != null and !petList.isEmpty()}">
                                    <tr th:each="pet : ${petList}">
                                        <td>
                                            <strong th:text="${pet.petName}">ë©ë©ì´</strong>
                                        </td>
                                        <td>
                                            <span th:text="${pet.petSpecies}">í¬ë©”ë¼ë‹ˆì•ˆ</span>
                                            <br>
                                            <small class="text-muted" th:text="${pet.petSize}">ì†Œí˜•</small>
                                        </td>
                                        <td>
                                            <span th:text="${pet.ownerName}">í™ê¸¸ë™</span>
                                            <br>
                                            <small class="text-muted" th:text="${pet.ownerPhone}">010-1234-5678</small>
                                        </td>
                                        <td>
                                            <span th:text="${pet.roomType}">Small Dog</span>
                                            <br>
                                            <small class="text-muted" th:text="${pet.roomImg}">room_301.jpg</small>
                                        </td>
                                        <td>
                                            <small>
                                                <i class="fa-solid fa-calendar-check text-success"></i>
                                                <span th:text="${pet.checkin}">2025-02-10</span>
                                                <br>
                                                <i class="fa-solid fa-calendar-xmark text-danger"></i>
                                                <span th:text="${pet.checkout}">2025-02-12</span>
                                            </small>
                                        </td>
                                        <td>
                                            <span th:if="${pet.petStatus == null}" class="status-badge status-none">
                                                ë¯¸ì„¤ì •
                                            </span>
                                            <span th:if="${pet.petStatus == 'RESTING'}" class="status-badge status-resting">
                                                <i class="fa-solid fa-bed"></i> íœ´ì‹ì¤‘
                                            </span>
                                            <span th:if="${pet.petStatus == 'PLAYING'}" class="status-badge status-playing">
                                                <i class="fa-solid fa-futbol"></i> ë†€ì´ì¤‘
                                            </span>
                                            <span th:if="${pet.petStatus == 'EATING'}" class="status-badge status-eating">
                                                <i class="fa-solid fa-utensils"></i> ì‹ì‚¬ì¤‘
                                            </span>
                                            <span th:if="${pet.petStatus == 'WALKING'}" class="status-badge status-walking">
                                                <i class="fa-solid fa-person-walking"></i> ì‚°ì±…ì¤‘
                                            </span>
                                            <span th:if="${pet.petStatus == 'BRAIN'}" class="status-badge status-brain">
                                                <i class="fa-solid fa-graduation-cap"></i> êµìœ¡ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘
                                            </span>
                                        </td>
                                        <td>
                                            <span th:text="${pet.nextSchedule != null ? pet.nextSchedule : '-'}">16:00 ì‚°ì±…</span>
                                        </td>
                                        <td>
                                            <!-- â­ ìˆ˜ì •: pet.petNo ì‚¬ìš© (ë°˜ë ¤ê²¬ ë²ˆí˜¸) -->
                                            <button class="btn btn-sm btn-primary edit-pet-btn" 
                                                    th:attr="data-pet-no=${pet.petNo}, 
                                                             data-pet-name=${pet.petName}, 
                                                             data-pet-status=${pet.petStatus}, 
                                                             data-next-schedule=${pet.nextSchedule}">
                                                <i class="fa-solid fa-pen"></i>
                                            </button>
                                        </td>
                                    </tr>
                                </th:block>
                                
                                <!-- ë°ì´í„°ê°€ ì—†ì„ ë•Œ -->
                                <th:block th:if="${petList == null or petList.isEmpty()}">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted py-5">
                                            <i class="fa-solid fa-inbox fs-1 mb-3 d-block"></i>
                                            í˜„ì¬ ì²´í¬ì¸ ì¤‘ì¸ ë°˜ë ¤ê²¬ì´ ì—†ìŠµë‹ˆë‹¤.
                                        </td>
                                    </tr>
                                </th:block>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        </section>

    </main>

</div>

<!-- ìƒíƒœ ìˆ˜ì • ëª¨ë‹¬ -->
<div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fa-solid fa-pen-to-square"></i>
                    ë°˜ë ¤ê²¬ ìƒíƒœ ìˆ˜ì •
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPetNo">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">ë°˜ë ¤ê²¬ ì´ë¦„</label>
                    <input type="text" class="form-control" id="editPetName" readonly>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fa-solid fa-circle-dot"></i>
                        í˜„ì¬ ìƒíƒœ
                    </label>
                    <select class="form-select" id="editStatus">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="RESTING">íœ´ì‹ì¤‘</option>
                        <option value="PLAYING">ë†€ì´ì¤‘</option>
                        <option value="EATING">ì‹ì‚¬ì¤‘</option>
                        <option value="WALKING">ì‚°ì±…ì¤‘</option>
                        <option value="BRAIN">êµìœ¡ í”„ë¡œê·¸ë¨ ì§„í–‰ì¤‘</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">
                        <i class="fa-solid fa-clock"></i>
                        ë‹¤ìŒ ì¼ì •
                    </label>
                    <input type="text" class="form-control" id="editNextSchedule" 
                           placeholder="ì˜ˆ: 16:00 ì‚°ì±…">
                    <small class="text-muted">ì˜ˆì‹œ: 16:00 ì‚°ì±…, 18:00 ì €ë…ì‹ì‚¬ ë“±</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-primary" onclick="saveStatus()">
                    <i class="fa-solid fa-save"></i>
                    ì €ì¥
                </button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    
    // CSRF í† í°
    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');
    
    // ì´ ì²´í¬ì¸ ìˆ˜ í‘œì‹œ
    document.addEventListener('DOMContentLoaded', () => {
        const petList = /*[[${petList}]]*/ [];
        document.getElementById('totalCount').textContent = petList ? petList.length : 0;
        
        // ìˆ˜ì • ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll('.edit-pet-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const petNo = this.getAttribute('data-pet-no');
                const petName = this.getAttribute('data-pet-name');
                const petStatus = this.getAttribute('data-pet-status');
                const nextSchedule = this.getAttribute('data-next-schedule');
                
                openEditModal(petNo, petName, petStatus, nextSchedule);
            });
        });
    });
    
    // ëª¨ë‹¬ ì—´ê¸°
    function openEditModal(petNo, petName, status, nextSchedule) {
        console.log('Opening modal:', { petNo, petName, status, nextSchedule });
        
        document.getElementById('editPetNo').value = petNo || '';
        document.getElementById('editPetName').value = petName || '';
        document.getElementById('editStatus').value = (status && status !== 'null') ? status : '';
        document.getElementById('editNextSchedule').value = (nextSchedule && nextSchedule !== 'null') ? nextSchedule : '';
        
        const modal = new bootstrap.Modal(document.getElementById('editModal'));
        modal.show();
    }
    
    // ìƒíƒœ ì €ì¥
    async function saveStatus() {
        const petNo = document.getElementById('editPetNo').value;
        const status = document.getElementById('editStatus').value;
        const nextSchedule = document.getElementById('editNextSchedule').value;
        
        if (!status) {
            alert('í˜„ì¬ ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }
        
        console.log('Saving status:', { petNo, status, nextSchedule });
        
        try {
            const response = await fetch(`/admin/petstatus/update/${petNo}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    [csrfHeader]: csrfToken
                },
                body: JSON.stringify({
                    status: status,
                    nextSchedule: nextSchedule || null
                })
            });
            
            console.log('Response status:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const result = await response.text();
            console.log('Response result:', result);
            
            if (result === 'SUCCESS') {
                alert('ìƒíƒœê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                location.reload();
            } else {
                alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        }
    }
    
    /*]]>*/
</script>

</body>
</html>
