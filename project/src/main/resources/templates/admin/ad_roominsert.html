<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">

<title>ê°ì‹¤ ì¶”ê°€</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
body { background-color: #f5f6f7; }
.sidebar { width: 240px; background-color: #1f2933; color: #fff; }   
.sidebar h5 { font-weight: 600; }
.sidebar .nav-link { color: #cbd5e1; padding: 10px 14px; border-radius: 6px; }
.sidebar .nav-link.active, .sidebar .nav-link:hover { background-color: #374151; color: #fff; }
.header { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 1rem; font-weight: 600; }
</style>
</head>
<body>

<div class="d-flex">

    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar p-4 vh-100">
        <h5 class="mb-4">ê´€ë¦¬ì í˜ì´ì§€</h5>
        <nav class="nav flex-column gap-1">
            <a class="nav-link" href="/admin">ğŸ“Š ë§¤ì¶œ ì¡°íšŒ</a>
            <a class="nav-link" href="/admin/usermanage">ğŸ‘¥ íšŒì› ê´€ë¦¬</a>
            <a class="nav-link active" href="/admin/service">âš™ï¸ ì„œë¹„ìŠ¤ ë° ì‹œì„¤ ê´€ë¦¬</a>
            <a class="nav-link" href="/admin/trainer">ğŸ‡ í›ˆë ¨ì‚¬ ê´€ë¦¬</a>
            <a class="nav-link" href="/admin/notice">ğŸ“ ê³µì§€ì‚¬í•­</a>
            <a class="nav-link" th:href="@{/admin/petstatus}">ğŸ¾ ë°˜ë ¤ê²¬ ìƒíƒœ ê´€ë¦¬</a>
        </nav>
    </aside>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <div class="flex-fill p-4">
        <div class="header mb-4">ê°ì‹¤ ì¶”ê°€</div>

        <div class="mb-3">
            <span th:text="${msg}"></span>
        </div>

        <div class="card">
            <div class="card-body">

              <form id="roomForm" action="/admin/add" method="post" enctype="multipart/form-data">


                    <div class="mb-3">
                        <label class="form-label">ê°ì‹¤ëª…</label>
                        <input type="text" class="form-control"
                               name="roomType"
                               placeholder="ê°ì‹¤ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ê°€ê²©</label>
                        <input type="number" class="form-control"
                               name="roomPrice"
                               placeholder="ê°€ê²©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ì„¸ë¶€ ì‚¬í•­</label>
                        <textarea class="form-control"
                                  name="etc"
                                  rows="4"></textarea>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ê°ì‹¤ ì´ë¯¸ì§€</label>
                        <input type="file"
                                class="form-control"
                                name="imgFile"
                                accept="image/*">

                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <a href="/admin/service" class="btn btn-secondary">ëª©ë¡ìœ¼ë¡œ</a>
                        <button type="submit" class="btn btn-primary">ë“±ë¡í•˜ê¸°</button>
                    </div>

                </form>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.getElementById("roomForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const form = e.target;
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

    let imgFileName = null;

    // 1ï¸âƒ£ ì´ë¯¸ì§€ ì—…ë¡œë“œ
    const imgInput = form.querySelector('input[name="imgFile"]');
    if (imgInput.files.length > 0) {
        const imgForm = new FormData();
        imgForm.append("imgFile", imgInput.files[0]);

        const res = await fetch("/admin/upload", {
            method: "POST",
            headers: { [csrfHeader]: csrfToken },
            body: imgForm
        });

        if (!res.ok) {
            alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
            return;
        }

        imgFileName = await res.text(); // ì„œë²„ì—ì„œ ë°˜í™˜ëœ íŒŒì¼ëª…
    }

    // 2ï¸âƒ£ ê°ì‹¤ ì •ë³´ JSON ìƒì„±
    const data = {
        roomType: form.querySelector('input[name="roomType"]').value,
        roomPrice: parseInt(form.querySelector('input[name="roomPrice"]').value),
        etc: form.querySelector('textarea[name="etc"]').value,
        img: imgFileName // ì—…ë¡œë“œ ì•ˆ í–ˆìœ¼ë©´ null
    };

    // 3ï¸âƒ£ POST ìš”ì²­ìœ¼ë¡œ DB ì €ì¥
    const createRes = await fetch("/admin/add", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            [csrfHeader]: csrfToken
        },
        body: JSON.stringify(data)
    });

    const result = await createRes.text();
    if (result === "SUCCESS") {
        alert("ê°ì‹¤ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.href = "/admin/service";
    } else {
        alert("ë“±ë¡ ì‹¤íŒ¨: " + result);
    }
});

</script>


</body>
</html> 
