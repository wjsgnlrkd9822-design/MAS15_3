<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
<title>ê°ì‹¤ ìˆ˜ì •</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f5f6f7; }
.sidebar { width: 240px; background-color: #1f2933; color: #fff; }   
.sidebar h5 { font-weight: 600; }
.sidebar .nav-link { color: #cbd5e1; padding: 10px 14px; border-radius: 6px; }
.sidebar .nav-link.active, .sidebar .nav-link:hover { background-color: #374151; color: #fff; }
.header { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 1rem; font-weight: 600; }
</style>
</head>
<body>
<div class="d-flex">

    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar p-4 vh-100">
        <h5 class="mb-4">ê´€ë¦¬ì í˜ì´ì§€</h5>
       <nav class="nav flex-column gap-1">
            <a class="nav-link" th:href="@{/admin}">ğŸ“Š ë§¤ì¶œ ì¡°íšŒ</a>
            <a class="nav-link" th:href="@{/admin/usermanage}">ğŸ‘¥ íšŒì› ê´€ë¦¬</a>
            <a class="nav-link" th:href="@{/admin/service}">âš™ï¸ ì„œë¹„ìŠ¤ ë° ì‹œì„¤ ê´€ë¦¬</a>
            <a class="nav-link" th:href="@{/admin/trainer}">ğŸ‡ í›ˆë ¨ì‚¬ ê´€ë¦¬</a>
            <a class="nav-link" th:href="@{/admin/notice}">ğŸ“ ê³µì§€ì‚¬í•­</a>
        </nav>
    </aside>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <div class="flex-fill p-4">
        <div class="header mb-4">ê°ì‹¤ ìˆ˜ì •</div>

        <div class="card">
            <div class="card-body">
                <!-- ìˆ˜ì • í¼ -->
                    <form id="updateForm" enctype="multipart/form-data">
                        <input type="hidden" name="roomNo" th:value="${room.roomNo}" id="roomNo">

                            <div class="mb-3">
                                <label class="form-label">ê°ì‹¤ëª…</label>
                                <input type="text" class="form-control"
                                    name="roomType" id="roomType"
                                    th:value="${room.roomType}" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ê°€ê²©</label>
                                <input type="number" class="form-control"
                                    name="roomPrice" id="roomPrice"
                                    th:value="${room.roomPrice}" required>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">ì„¸ë¶€ ì‚¬í•­</label>
                                <textarea class="form-control"
                                        name="etc"
                                        rows="4" id="etc"
                                        th:text="${room.etc}"></textarea>
                            </div>
                                <div class="mb-3">
                                    <label class="form-label">ê°ì‹¤ ì´ë¯¸ì§€</label>
                                    <input type="file" class="form-control" name="imgFile" id="imgFile">

                                    <!-- ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ -->
                                    <div class="mt-2">
                                        <small class="text-muted">ê¸°ì¡´ ì´ë¯¸ì§€:</small><br>
                                        <img th:if="${room.img != null}" 
                                             th:src="@{/uploads/{img}(img=${room.img})}"
                                            alt="ê¸°ì¡´ ì´ë¯¸ì§€" 
                                            style="width:200px; height:auto; border:1px solid #ddd; padding:2px; border-radius:4px;">
                                    </div>
                                </div>

                            <div class="d-flex justify-content-end gap-2">
                                <a th:href="@{/admin/service}" class="btn btn-secondary">ëª©ë¡</a>
                                <button type="submit" class="btn btn-primary">ì €ì¥</button>
                                <button type="button" class="btn btn-danger" onclick="actionDelete()">ì‚­ì œ</button>
                            </div>
                    </form>

            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;

document.getElementById("updateForm").addEventListener("submit", async function(e) {
    e.preventDefault(); // í¼ ê¸°ë³¸ submit ë§‰ê¸°

    const form = e.target;
    const roomNo = document.getElementById("roomNo").value;
    const imgInput = document.getElementById("imgFile");


    let imgFileName = null;

    // 1ï¸âƒ£ ì´ë¯¸ì§€ ì—…ë¡œë“œ
    if (imgInput.files.length > 0) {
        const imgForm = new FormData();
        imgForm.append("imgFile", imgInput.files[0]);

        const res = await fetch("/admin/upload", {
            method: "POST",
            headers: { [csrfHeader]: csrfToken },
            body: imgForm
        });

        if (!res.ok) {
            alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
            return;
        }

        imgFileName = await res.text(); // ì—…ë¡œë“œëœ íŒŒì¼ëª…
    }

    // 2ï¸âƒ£ JSON ë°ì´í„° ìƒì„±
    const data = {
        roomType: document.getElementById("roomType").value,
        roomPrice: parseInt(document.getElementById("roomPrice").value), // ìˆ«ì ë³€í™˜ í•„ìˆ˜
        etc: document.getElementById("etc").value,
        img: imgFileName // nullì´ë©´ ì„œë²„ì—ì„œ default ì²˜ë¦¬
    };

    // 3ï¸âƒ£ PUT/POST ìš”ì²­
    const updateRes = await fetch(`/admin/update/${roomNo}`, {
        method: "POST", // ê¸°ì¡´ ì»¨íŠ¸ë¡¤ëŸ¬ @PostMapping ì‚¬ìš©
        headers: {
            "Content-Type": "application/json",
            [csrfHeader]: csrfToken
        },
        body: JSON.stringify(data)
    });

    const result = await updateRes.text();

    if (result === "SUCCESS") {
        alert("ê°ì‹¤ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        window.location.href = "/admin/service";
    } else {
        alert("ìˆ˜ì • ì‹¤íŒ¨: " + result);
    }
});
	async function actionDelete() {
		  if (!confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
		
		  const roomNo = document.getElementById("roomNo").value;
		
		  try {
		    const response = await fetch(`/admin/room/delete/${roomNo}`, {
		      method: "DELETE",
          headers: { [csrfHeader]: csrfToken },
		    });
		
		    if (response.ok) {
          alert("ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
          location.href = "/admin/service";
        } else {
          alert("ê²Œì‹œê¸€ ì‚­ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.")
        }
		
		  } catch (err) {
		    alert(err.message);
		  }
		}

</script>

</body>
</html>
