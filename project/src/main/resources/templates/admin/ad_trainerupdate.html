<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="_csrf" th:content="${_csrf.token}">
<meta name="_csrf_header" th:content="${_csrf.headerName}">
<title>í›ˆë ¨ì‚¬ ìˆ˜ì •</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color: #f5f6f7; }
.sidebar { width: 240px; background-color: #1f2933; color: #fff; }   
.sidebar h5 { font-weight: 600; }
.sidebar .nav-link { color: #cbd5e1; padding: 10px 14px; border-radius: 6px; }
.sidebar .nav-link.active, .sidebar .nav-link:hover { background-color: #374151; color: #fff; }
.header { background: #fff; border-bottom: 1px solid #e5e7eb; padding: 1rem; font-weight: 600; }
</style>
</head>
<body>
<div class="d-flex">

    <!-- ì‚¬ì´ë“œë°” -->
    <aside class="sidebar p-4 vh-100">
        <h5 class="mb-4">ê´€ë¦¬ì í˜ì´ì§€</h5>
      <nav class="nav flex-column gap-1">
            <a class="nav-link" th:href="@{/admin}">ğŸ“Š ë§¤ì¶œ ì¡°íšŒ</a>
            <a class="nav-link" th:href="@{/admin/usermanage}">ğŸ‘¥ íšŒì› ê´€ë¦¬</a>
            <a class="nav-link" th:href="@{/admin/service}">âš™ï¸ ì„œë¹„ìŠ¤ ë° ì‹œì„¤ ê´€ë¦¬</a>
            <a class="nav-link" th:href="@{/admin/trainer}">ğŸ‡ í›ˆë ¨ì‚¬ ê´€ë¦¬</a>
            <a class="nav-link" th:href="@{/admin/notice}">ğŸ“ ê³µì§€ì‚¬í•­</a>
            <a class="nav-link" th:href="@{/admin/petstatus}">ğŸ¾ ë°˜ë ¤ê²¬ ìƒíƒœ ê´€ë¦¬</a>
        </nav>
    </aside>

    <!-- ë©”ì¸ ì˜ì—­ -->
    <div class="flex-fill p-4">
        <div class="header mb-4">í›ˆë ¨ì‚¬ ìˆ˜ì •</div>

        <div class="card">
            <div class="card-body">
                <form id="trainerForm" action="/admin/trainerupdate" method="put">
                    <!-- DBì—ì„œ ë¶ˆëŸ¬ì˜¨ trainer_no hidden -->    
                    <input type="hidden" name="trainerNo" th:value="${trainer.trainerNo}" id="trainerNo">   
                    <div class="mb-3">
                        <label class="form-label">í›ˆë ¨ì‚¬ ì´ë¦„</label>
                        <input type="text" class="form-control" id="trainerName"  name="trainerName " th:value="${trainer.trainerName}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì„±ë³„</label>
                        <select class="form-select" name="gender" id="gender" required>
                            <option value="">ì„ íƒ</option>
                            <option value="ë‚¨" th:selected="${trainer.gender == 'ë‚¨'}">ë‚¨</option>
                            <option value="ì—¬" th:selected="${trainer.gender == 'ì—¬'}">ì—¬</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ì„¸ë¶€ì‚¬í•­</label>
                        <textarea class="form-control" name="description" rows="4" id="description" th:text="${trainer.detail}"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">íŠ¸ë ˆì´ë„ˆ ì´ë¯¸ì§€</label>
                        <input type="file"
                                class="form-control"
                                name="imgFile"
                                accept="image/*">
                                <!-- ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ -->
                                    <div class="mt-2">
                                        <small class="text-muted">ê¸°ì¡´ ì´ë¯¸ì§€:</small><br>
                                        <img th:if="${trainer.img != null}" 
                                            th:src="@{'/uploads/' + ${trainer.img}}" 
                                            alt="ê¸°ì¡´ ì´ë¯¸ì§€" 
                                            style="width:200px; height:auto; border:1px solid #ddd; padding:2px; border-radius:4px;">
                                    </div>
                                </div>

                    </div>

                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class= "btn btn-danger" onclick="actiondelete()">ì‚­ì œí•˜ê¸°</button>
                        <button type="submit" class="btn btn-primary">ìˆ˜ì •í•˜ê¸°</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

</div>
<script>
    const trainerNo = document.getElementById("trainerNo").value;
    const csrfToken = document.querySelector('meta[name="_csrf"]').content;
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').content;
document.getElementById("trainerForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    const form = e.target;

    let imgFileName = null;

    // 1ï¸âƒ£ ì´ë¯¸ì§€ ì—…ë¡œë“œ
    const imgInput = form.querySelector('input[name="imgFile"]');
    if (imgInput.files.length > 0) {
        const imgForm = new FormData();
        imgForm.append("imgFile", imgInput.files[0]);

        const res = await fetch("/admin/upload", {
            method: "POST",
            headers: { [csrfHeader]: csrfToken },
            body: imgForm
        });
        
        if (!res.ok) {
            alert("ì´ë¯¸ì§€ ì—…ë¡œë“œ ì‹¤íŒ¨");
            return;
        }

        imgFileName = await res.text();
    }

    const data = {
        trainerName: document.getElementById("trainerName").value,
        gender : document.getElementById("gender").value,
        detail : document.getElementById("description").value,
        img: imgFileName
    }
    const response = await fetch(`/admin/trainerupdate/${trainerNo}`,{
        method:"PUT",
        headers : {
            "Content-Type": "application/json",
            [csrfHeader]: csrfToken
        },
        body: JSON.stringify(data)
    })
        const result = await response.text();

        if (result === "SUCCESS"){
            alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.")
            window.location.href = "/admin/trainer";
        }else{
                alert("ìˆ˜ì • ì‹¤íŒ¨ : " + result); 
            }

        });
        async function actiondelete() {
            if( !confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ")) return;
            try {
                const response = await fetch(`/admin/trainer/delete/${trainerNo}`,{
                method: "DELETE",
                headers: {
                    [csrfHeader]: csrfToken
                }
            });
            const result = await response.text();
            if (result === "SUCCESS") {
                alert("í›ˆë ¨ì‚¬ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                window.location.href = "/admin/trainer";
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨ : " + result);
            }
        } catch (error) {
            console.error("Error deleting trainer:", error);
        }
            
        }


</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
