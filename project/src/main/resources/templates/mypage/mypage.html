<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>마이페이지</title>
  <!-- 공통 CSS -->
  <th:block th:replace="~{fragments/link::link}"></th:block>
  <th:block th:replace="~{fragments/link::mypage-link}"></th:block>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Font Awesome 아이콘 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
</head>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<body>

  <!-- 헤더 -->
  <th:block th:replace="~{fragments/header::header}"></th:block>

  <!-- 마이 페이지 헤더 -->
  <section class="mypage-header">
    <div class="mypage-header-inner">
      <br>
      <h2>마이 페이지</h2>
      <p>나의 예약 내역과 정보를 확인하고 관리하세요</p>
    </div>
  </section>



  <!-- 내 정보 -->
  <section class="mypage-info">
    <div class="mypage-info-inner">
      <h3>내 정보</h3>
      <ul class="list-group mb-3">
        <li class="list-group-item"><i class="fas fa-user-circle"></i> 아이디: <span id="username"></span></li>
        <li class="list-group-item"><i class="fas fa-user"></i> 이름: <span id="name"></span></li>
        <li class="list-group-item"><i class="fas fa-birthday-cake"></i> 생년월일: <span id="birth"></span></li>
        <li class="list-group-item"><i class="fas fa-envelope"></i> 이메일: <span id="email"></span></li>
        <li class="list-group-item"><i class="fas fa-phone"></i> 전화번호: <span id="phone"></span></li>
        <li class="list-group-item"><i class="fas fa-map-marker-alt"></i> 주소: <span id="address"></span></li>
      </ul>
      <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editModal">
        정보 수정
      </button>
    </div>
  </section>


  <!-- 내 정보 수정 모달 -->
  <div class="modal fade" id="editModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">

        <div class="modal-header">
          <h5 class="modal-title">내 정보 수정</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <label>아이디(변경불가)</label>
          <input id="editUsername" class="form-control mb-2" placeholder="아이디" readonly>
          <label>이름(변경불가)</label>
          <input id="editName" class="form-control mb-2" placeholder="이름" readonly>
          <label>이메일</label>
          <input id="editEmail" class="form-control mb-2" placeholder="이메일">
          <label>전화번호</label>
          <input id="editPhone" class="form-control mb-2" placeholder="전화번호">
          <label>생년월일</label>
          <input type="date" id="editBirth" class="form-control mb-2" />
          <label>주소</label>
          <input id="editAddress" class="form-control mb-2" placeholder="주소">
        </div>

        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button class="btn btn-primary" onclick="updateMyInfo()">수정</button>
        </div>

      </div>
    </div>
  </div>


  <!-- =============================================================================================================== -->

<!-- 펫 정보 추가 -->
  <section class="mypage-pets">
    <div class="mypage-pets-inner">
      <h3>나의 반려견</h3>

      <!-- 반려견 카드가 동적으로 로드될 컨테이너 -->
      <div id="petCardsContainer" class="pet-cards-wrapper">
        <!-- JavaScript에서 동적으로 카드가 추가됩니다 -->
      </div>

      <!-- 반려견 추가 버튼 -->
      <button type="button" class="add-pet-card" data-bs-toggle="modal" data-bs-target="#addPetModal">
        <i class="fas fa-plus-circle"></i>
        <span>반려견 추가</span>
      </button>

      <!-- 반려견 추가 모달 -->
      <div class="modal fade" id="addPetModal" tabindex="-1" aria-labelledby="addPetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addPetModalLabel">반려견 추가</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="addPetForm">
              <!-- 모달 내용 -->
              <div class="modal-body">
                <div class="mb-3">
                  <label for="petName" class="form-label">이름</label>
                  <input type="text" class="form-control" id="addPetName" name="name" required>
                </div>
                <div class="mb-3">
                  <label for="petSpecies" class="form-label">종</label>
                  <input type="text" class="form-control" id="addPetSpecies" name="species" required>
                </div>
                <div class="mb-3">
                  <label for="petSize" class="form-label">크기</label>
                  <select class="form-select" id="addPetSize" name="size" required>
                    <option value="소형">소형</option>
                    <option value="중형">중형</option>
                    <option value="대형">대형</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="petAge" class="form-label">나이</label>
                  <input type="number" class="form-control" id="addPetAge" name="age" required>
                </div>
                <div class="mb-3">
                  <label for="petWeight" class="form-label">몸무게</label>
                  <input type="number" class="form-control" id="addPetWeight" name="weight" step="0.1" required>
                </div>
                <div class="mb-3">
                  <label for="petGender" class="form-label">성별</label>
                  <select class="form-select" id="addPetGender" name="gender" required>
                    <option value="수컷">수컷</option>
                    <option value="암컷">암컷</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="petNeutered" class="form-label">중성화 여부</label>
                  <select class="form-select" id="addPetNeutered" name="neutered" required>
                    <option value="예">예</option>
                    <option value="아니오">아니오</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="petVaccination" class="form-label">예방접종 여부</label>
                  <select class="form-select" id="addPetVaccination" name="vaccination" required>
                    <option value="예">예</option>
                    <option value="아니오">아니오</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="petProfile" class="form-label">프로필 이미지</label>
                  <input type="file" class="form-control" id="addPetProfile" name="profileImg">
                  <img id="addProfilePreview" class="img-thumbnail mt-2" style="max-width:150px; display:none;"  onclick="openImagePreview(this.src)">
                </div>
                <div class="mb-3">
                  <label for="petCertificate" class="form-label">건강 증명서</label>
                  <input type="file" class="form-control" id="addPetCertificate" name="certificateFile">
                </div>
                <div class="mb-3">
                  <label for="petEtc" class="form-label">기타 사항</label>
                  <textarea class="form-control" id="addPetEtc" name="etc" rows="2"></textarea>
                </div>
              </div>
              <!-- 모달 푸터 -->
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="submit" class="btn btn-primary">추가</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- 이미지 확대 모달 -->
<div class="modal fade" id="imagePreviewModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content bg-transparent border-0">
      <div class="modal-body text-center">
        <img id="imagePreviewModalImg"
             class="img-fluid rounded"
             style="max-height: 80vh;">
      </div>
    </div>
  </div>
</div>



    <!-- 반려견 수정하기 모달 -->
    <div class="modal fade" id="editPetModal" tabindex="-1" aria-labelledby="editPetModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="editPetModalLabel">반려견 정보 수정</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editPetForm">
              <!-- 모달 내용 -->
              <div class="modal-body">
                <input type="hidden" id="petNo" name="petNo">

                <div class="mb-3">
                  <label for="petName" class="form-label">이름</label>
                  <input type="text" class="form-control" id="petName" name="name" required>
                </div>
                <div class="mb-3">
                  <label for="petSpecies" class="form-label">종</label>
                  <input type="text" class="form-control" id="petSpecies" name="species" required>
                </div>
                <div class="mb-3">
                  <label for="petSize" class="form-label">크기</label>
                  <select class="form-select" id="petSize" name="size" required>
                    <option value="소형">소형</option>
                    <option value="중형">중형</option>
                    <option value="대형">대형</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="petAge" class="form-label">나이</label>
                  <input type="number" class="form-control" id="petAge" name="age" required>
                </div>
                <div class="mb-3">
                  <label for="petWeight" class="form-label">몸무게</label>
                  <input type="number" class="form-control" id="petWeight" name="weight" step="0.1" required>
                </div>
                <div class="mb-3">
                  <label for="petGender" class="form-label">성별</label>
                  <select class="form-select" id="petGender" name="gender" required>
                    <option value="수컷">수컷</option>
                    <option value="암컷">암컷</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="petNeutered" class="form-label">중성화 여부</label>
                  <select class="form-select" id="petNeutered" name="neutered" required>
                    <option value="예">예</option>
                    <option value="아니오">아니오</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="petVaccination" class="form-label">예방접종 여부</label>
                  <select class="form-select" id="petVaccination" name="vaccination" required>
                    <option value="예">예</option>
                    <option value="아니오">아니오</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="petProfile" class="form-label">프로필 이미지</label>
                  <input type="file" class="form-control" id="petProfile" name="profileImg">
                  <img id="profilePreview" class="img-thumbnail mt-2" style="max-width:150px; display:none;"  onclick="openImagePreview(this.src)">
                </div>
                <div class="mb-3">
                  <label for="petCertificate" class="form-label">건강 증명서</label>
                  <input type="file" class="form-control" id="petCertificate" name="certificateFile">
                </div>
                <div class="mb-3">
                  <label for="petEtc" class="form-label">기타 사항</label>
                  <textarea class="form-control" id="petEtc" name="etc" rows="2"></textarea>
                </div>
              </div>
              <!-- 모달 푸터 -->
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="submit" class="btn btn-primary">수정</button>
                <button type="button" class="btn btn-danger" onclick="deletePetUI()">삭제</button>
              </div>
            </form>
          </div>
        </div>
      </div>
  </section>


 










  <!-- ============================================================================================================================ -->



  <!-- 호텔 예약 내역 -->
  <section class="mypage-reservations">
        <div class="mypage-reservations-inner">
            <h3>호텔 예약 내역</h3>
            <table>
                <thead>
                    <tr>
                        <th>예약 번호</th>
                        <th>반려견 이름</th>
                        <th>체크인</th>
                        <th>체크아웃</th>
                        <th>상태</th>
                        <th>관리</th>
                    </tr>
                </thead>
                <tbody>
                <tr th:each="res : ${reservations}">
                  <td><span th:text="${res.resNo}"></span></td>
                  <td th:text="${res.petName}">반려견 이름</td>
                  <td th:text="${res.checkin}">2024-07-01</td>
                  <td th:text="${res.checkout}">2024-07-05</td>
                  <td>예약 완료</td>
                  <td>
  <!-- ✅ 안전하게 모달 열기 -->
  <button class="btn-edit" type="button"
          th:onclick="'openEditModal(' + ${res.resNo} + ')'">
    수정
  </button>
</td>

                </tr>
                </tbody>
            </table>
        </div>
    </section>

    <!-- ✅ 예약 수정 모달 -->
    <div class="modal fade" id="editReservationModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

          <div class="modal-header">
            <h5 class="modal-title">예약 수정</h5>
            <button class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="editResNo">
            
            <div class="mb-3">
              <label>반려견 이름</label>
              <input id="editPetName" class="form-control" readonly>
            </div>
            
            <div class="mb-3">
              <label>체크인 날짜</label>
              <input type="text" id="editCheckin" class="form-control">
            </div>
            
            <div class="mb-3">
              <label>체크아웃 날짜</label>
              <input type="text" id="editCheckout" class="form-control">
            </div>
            
            <div class="mb-3">
              <label>박 수</label>
              <input id="editNights" class="form-control" readonly>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <button class="btn btn-primary" onclick="updateReservation()">수정 완료</button>
            <button class="btn btn-danger" onclick="deleteReservation()">삭제</button>
          </div>

        </div>
      </div>
    </div>

  <!-- 푸터 -->
  <th:block th:replace="~{fragments/footer::footer}"></th:block>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- 마이페이지 JS -->
  <script src="/js/mypage.js"></script>
  <!-- 마이페이지 반려견 JS -->
  <!-- <script src="/js/mypagePet.js"></script> -->
  <script src="/js/mypagePetApi.js"></script>
  <script src="/js/mypagePetUi.js"></script>
  <!-- ✅ 예약 수정 JavaScript -->
<script>
let checkinPicker, checkoutPicker;

// 모달 열기
function openEditModal(resNo) {
    fetch(`/api/reservation/${resNo}`)
        .then(res => res.json())
        .then(data => {
            document.getElementById('editResNo').value = data.resNo;
            document.getElementById('editPetName').value = data.petName;
            
            // Flatpickr 초기화
            if (checkinPicker) checkinPicker.destroy();
            if (checkoutPicker) checkoutPicker.destroy();
            
            const today = new Date();
            today.setHours(0,0,0,0);
            
            checkinPicker = flatpickr("#editCheckin", {
                dateFormat: "Y-m-d",
                defaultDate: data.checkin,
                minDate: today,
                onChange: function(selectedDates) {
                    if (selectedDates.length > 0) {
                        const minCheckout = new Date(selectedDates[0].getTime());
                        minCheckout.setDate(minCheckout.getDate() + 1);
                        checkoutPicker.set('minDate', minCheckout);
                    }
                    calculateNights();
                }
            });
            
            checkoutPicker = flatpickr("#editCheckout", {
                dateFormat: "Y-m-d",
                defaultDate: data.checkout,
                minDate: new Date(data.checkin),
                onChange: calculateNights
            });
            
            calculateNights();
            
            // 모달 열기
            const modal = new bootstrap.Modal(document.getElementById('editReservationModal'));
            modal.show();
        });
}

// 박 수 계산
function calculateNights() {
    const checkin = checkinPicker.selectedDates[0];
    const checkout = checkoutPicker.selectedDates[0];
    
    if (checkin && checkout && checkout > checkin) {
        const nights = Math.ceil((checkout - checkin) / (1000*60*60*24));
        document.getElementById('editNights').value = nights + '박';
    } else {
        document.getElementById('editNights').value = '0박';
    }
}

// 예약 수정
function updateReservation() {
    const resNo = document.getElementById('editResNo').value;
    const checkin = document.getElementById('editCheckin').value;
    const checkout = document.getElementById('editCheckout').value;

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    const formData = new FormData();
    formData.append('checkin', checkin);
    formData.append('checkout', checkout);
    formData.append('total', 100000); // 임시

    fetch(`/api/reservation/update/${resNo}`, {
        method: 'POST',
        body: formData,
        headers: {
            [csrfHeader]: csrfToken // ✅ CSRF 헤더 추가
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload(); // 페이지 새로고침
        } else {
            alert(data.message);
        }
    })
    .catch(err => {
        alert('수정 중 오류가 발생했습니다.');
        console.error(err);
    });
}

function deleteReservation() {
    const resNo = document.getElementById('editResNo').value;

    if (!confirm("정말 이 예약을 삭제하시겠습니까?")) return;

    const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    fetch(`/api/reservation/delete/${resNo}`, {
        method: 'DELETE',
        headers: {
            [csrfHeader]: csrfToken
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert(data.message);
        }
    })
    .catch(err => {
        alert('삭제 중 오류가 발생했습니다.');
        console.error(err);
    });
}


</script>
</body>

</html>