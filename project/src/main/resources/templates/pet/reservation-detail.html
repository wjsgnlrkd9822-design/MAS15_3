<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>예약 화면</title>

<!-- 공통 링크 및 CSS 불러오기 -->
<th:block th:replace="~{fragments/linkreservation-detail::link}"></th:block>
<th:block th:replace="~{fragments/link::link}"></th:block>
<link rel="stylesheet" th:href="@{/css/reservation-detail.css}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<!-- 선택된 서비스 카드 스타일 -->
<style>
.service-card.selected {
    border: 3px solid #CC9966; /* 선택 시 테두리 강조 */
}
</style>
</head>
<body>

<!-- 헤더 불러오기 -->
<th:block th:replace="~{fragments/header::header}"></th:block>
    
<!-- 페이지 제목 -->
<p class="reservation-text">Reservation</p>

<div class="reservation-wrapper">

    <!-- 달력 + 객실 카드 영역 -->
    <div class="reservation-detail-container">
        <!-- 왼쪽 달력 영역 -->
        <div class="reservation-calendar">
            <div class="calendar-title">
                <div class="calendar-title-row">
                    <i class="fa-solid fa-calendar-days"></i>
                    <h3>날짜 선택</h3>
                </div>
                <p>체크인과 체크아웃 날짜를 선택해주세요</p>
            </div>

            <!-- 체크인/체크아웃 입력 -->
            <div class="calendar-row">
                <div class="calendar-box">
                    <div class="calendar-label">
                        <i class="fa-solid fa-right-to-bracket"></i>
                        <p>체크인</p>
                    </div>
                    <input type="text" id="checkin-date">
                </div>

                <div class="calendar-box">
                    <div class="calendar-label">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <p>체크아웃</p>
                    </div>
                    <input type="text" id="checkout-date">
                </div>
            </div>

            <!-- 숙박일 표시 -->
            <div class="night-box">
                총 <span id="night-count">0</span>박 숙박
            </div>

            <!-- 안내 정보 -->
            <div class="info-box">
                <p>체크인: 오전 10시</p>
                <p>체크아웃: 오후 6시</p>
                <p>최소 예약: 1박</p>
                <p>취소는 체크인 3일 전까지 가능합니다</p>
            </div>
        </div>

        <!-- 오른쪽 객실 카드 영역 -->
        <div class="reservation-detail">
            <img th:src="@{'/img/' + ${room.img}}" class="room-detail-image">
            <h2 class="room-title" th:text="${room.roomType} + ' Room' "></h2>

            <!-- 객실 특징 -->
            <ul class="room-features">
                <li><i class="fa-solid fa-temperature-high"></i>개별 온도 조절 시스템</li>
                <li><i class="fa-solid fa-bed"></i>프리미엄 침구 & 매트리스</li>
                <li><i class="fa-solid fa-video"></i>24시간 CCTV 모니터링</li>
                <li><i class="fa-solid fa-dog"></i>전용 놀이 & 휴식 공간</li>
                <li><i class="fa-solid fa-broom"></i>매일 2회 위생 관리</li>
            </ul>

            <!-- 객실 요금 -->
            <div class="price-box">
                <span id="room-price" th:text="${room.roomPrice}"></span>원
                <small>/ 1박</small>
            </div>
        </div>
    </div>

    <!-- 호텔 추가 서비스 영역 -->
    <div class="room-service">
        <h3 class="hotelservicetext">호텔 추가 서비스</h3>
        <ul class="service-list">
            <li th:each="service : ${roomServiceList}">
                <div class="service-card">
                    <!-- 상단: 아이콘, 이름, 가격 -->
                    <div class="service-top">
                        <div class="service-info">
                            <span class="service-icon" th:switch="${service.serviceName}">
                                <i th:case="'그루밍 서비스'" class="fa-solid fa-scissors"></i>
                                <i th:case="'프리미엄 식사'" class="fa-solid fa-utensils"></i>
                                <i th:case="'훈련 프로그램'" class="fa-solid fa-dog"></i>
                                <i th:case="'사진 촬영'" class="fa-solid fa-camera"></i>
                                <i th:case="*"></i>
                            </span>
                            <span class="service-name" th:text="${service.serviceName}"></span>
                        </div>
                        <small class="service-price" th:text="'+' + ${service.servicePrice} + '원'"></small>
                    </div>

                    <!-- 하단: 설명, 체크박스 -->
                    <div class="service-bottom">
                        <p class="service-desc" th:text="${service.description}"></p>
                        <input type="checkbox" class="service-checkbox" 
                            th:value="${service.servicePrice}" 
                            th:data-name="${service.serviceName}">
                    </div>
                </div>
            </li>
        </ul>
    </div>

    <!-- 결제 요약 영역 -->
    <div class="payment-summary">
        <div class="summary-title">예약 요약</div>

        <div class="summary-row">
            <span>기간</span>
            <span id="summary-date">-</span>
        </div>

        <div class="summary-row">
            <span>객실 요금 (1박)</span>
            <span id="summary-room">0원</span>
        </div>

        <div class="summary-row">
            <span>선택 서비스</span>
            <span id="summary-service">0원</span>
        </div>

        <div class="summary-divider"></div>

        <div class="summary-row total">
            <span>총 결제 금액</span>
            <span id="summary-total">0원</span>
        </div>

        <!-- 예약 버튼 -->
        <a id="reserveBtn"
        th:href="@{/pet/reservation/confirm/{roomNo}(roomNo=${room.roomNo})}"
        class="summary-btn">
            예약하기
        </a>
    </div>

</div>

<!-- 푸터 불러오기 -->
<th:block th:replace="~{fragments/footer::footer}"></th:block>

<!-- Flatpickr 날짜 선택 라이브러리 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){
    // 객실 1박 요금 불러오기 및 포맷
    let rawRoomPrice = parseInt(document.getElementById('room-price').textContent);
    document.getElementById('room-price').textContent = rawRoomPrice.toLocaleString();

    const nightEl = document.getElementById("night-count");
    const serviceCheckboxes = document.querySelectorAll(".service-checkbox");
    const serviceCards = document.querySelectorAll(".service-card");

    // 오늘 날짜 기준
    const today = new Date();
    today.setHours(0,0,0,0);

    // 과거 날짜 비활성화
    function isPastDate(date){
        const d = new Date(date);
        d.setHours(0,0,0,0);
        return d < today;
    }

    // 체크인/체크아웃 달력
    const checkinInput = flatpickr("#checkin-date", { inline:true, disable:[isPastDate], onChange:updateSummary });
    const checkoutInput = flatpickr("#checkout-date", { inline:true, disable:[isPastDate], onChange:updateSummary });

    // 날짜 포맷
    function formatDate(d){
        return d.getFullYear() + "." + String(d.getMonth()+1).padStart(2,"0") + "." + String(d.getDate()).padStart(2,"0");
    }

    // 결제 요약 갱신
    function updateSummary(){
        const checkin = checkinInput.selectedDates[0];
        const checkout = checkoutInput.selectedDates[0];

        // 숙박일 계산
        let nights = 0;
        if(checkin && checkout && checkout > checkin){
            nights = (checkout - checkin) / (1000*60*60*24);
        }

        let roomTotal = nights * rawRoomPrice;

        // 서비스 요금은 항상 계산
        let serviceTotal = 0;
        serviceCheckboxes.forEach(cb => { if(cb.checked) serviceTotal += parseInt(cb.value); });

        nightEl.textContent = nights;
        document.getElementById("summary-date").textContent = checkin && checkout ? formatDate(checkin) + " ~ " + formatDate(checkout) : "-";
        document.getElementById("summary-room").textContent = roomTotal.toLocaleString() + "원";
        document.getElementById("summary-service").textContent = serviceTotal.toLocaleString() + "원";
        document.getElementById("summary-total").textContent = (roomTotal + serviceTotal).toLocaleString() + "원";
    }

    // 서비스 체크박스 클릭 시 카드 선택 표시 및 갱신
    serviceCheckboxes.forEach(cb => {
        cb.addEventListener("change", function(){
            const card = this.closest('.service-card');
            card.classList.toggle('selected', this.checked);
            updateSummary();
        });
    });

    // 카드 클릭 시 체크박스 토글 + 갱신
    serviceCards.forEach(card => {
        const checkbox = card.querySelector('.service-checkbox');
        card.addEventListener('click', (e) => {
            if(e.target !== checkbox){
                checkbox.checked = !checkbox.checked;
            }
            card.classList.toggle('selected', checkbox.checked);
            updateSummary();
        });
    });

    // 예약 버튼 클릭 시 URL 생성 및 검증
    document.getElementById("reserveBtn").addEventListener("click", function(e){
        const checkin = checkinInput.selectedDates[0];
        const checkout = checkoutInput.selectedDates[0];

        if(!checkin || !checkout || checkout <= checkin){
            alert("올바른 입실/퇴실 날짜를 선택해주세요.");
            e.preventDefault();
            return;
        }

        const nights = (checkout - checkin) / (1000*60*60*24);
        let total = nights * rawRoomPrice;
        serviceCheckboxes.forEach(cb => { if(cb.checked) total += parseInt(cb.value); });

        const format = d => d.toISOString().split("T")[0];
        const url = this.getAttribute("href")
            + "?checkin=" + format(checkin)
            + "&checkout=" + format(checkout)
            + "&nights=" + nights
            + "&total=" + total;

        this.setAttribute("href", url);
    });
});
</script>

</body>
</html>
