<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>예약 화면</title>

<!-- 공통 링크 및 CSS 불러오기 -->
<th:block th:replace="~{fragments/linkreservation-detail::link}"></th:block>
<th:block th:replace="~{fragments/link::link}"></th:block>
<link rel="stylesheet" th:href="@{/css/reservation-detail.css}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

<style>
.service-card.selected {
    border: 3px solid #CC9966;
}
</style>
</head>
<body>

<th:block th:replace="~{fragments/header::header}"></th:block>

<p class="reservation-text">Reservation</p>

<div class="reservation-wrapper">

    <div class="reservation-detail-container">
        <div class="reservation-calendar">
            <div class="calendar-title">
                <div class="calendar-title-row">
                    <i class="fa-solid fa-calendar-days"></i>
                    <h3>날짜 선택</h3>
                </div>
                <p>체크인과 체크아웃 날짜를 선택해주세요</p>
            </div>

            <div class="calendar-row">
                <div class="calendar-box">
                    <div class="calendar-label">
                        <i class="fa-solid fa-right-to-bracket"></i>
                        <p>체크인</p>
                    </div>
                    <input type="text" id="checkin-date">
                </div>

                <div class="calendar-box">
                    <div class="calendar-label">
                        <i class="fa-solid fa-right-from-bracket"></i>
                        <p>체크아웃</p>
                    </div>
                    <input type="text" id="checkout-date">
                </div>
            </div>

            <div class="night-box">
                총 <span id="night-count">0</span>박 숙박
            </div>

            <div class="info-box">
                <p>체크인: 오전 10시</p>
                <p>체크아웃: 오후 6시</p>
                <p>최소 예약: 1박</p>
                <p>취소는 체크인 3일 전까지 가능합니다</p>
            </div>
        </div>

        <div class="reservation-detail">
            <img th:src="@{'/img/' + ${room.img}}" class="room-detail-image">
            <h2 class="room-title" th:text="${room.roomType} + ' Room' "></h2>

            <ul class="room-features">
                <li><i class="fa-solid fa-temperature-high"></i>개별 온도 조절 시스템</li>
                <li><i class="fa-solid fa-bed"></i>프리미엄 침구 & 매트리스</li>
                <li><i class="fa-solid fa-video"></i>24시간 CCTV 모니터링</li>
                <li><i class="fa-solid fa-dog"></i>전용 놀이 & 휴식 공간</li>
                <li><i class="fa-solid fa-broom"></i>매일 2회 위생 관리</li>
            </ul>

            <div class="price-box">
                <span id="room-price" th:text="${room.roomPrice}"></span>원
                <small>/ 1박</small>
            </div>
        </div>
    </div>

    <div class="room-service">
        <h3 class="hotelservicetext">호텔 추가 서비스</h3>
        <ul class="service-list">
            <li th:each="service : ${roomServiceList}">
                <div class="service-card">
                    <div class="service-top">
                        <div class="service-info">
                            <span class="service-icon" th:switch="${service.serviceName}">
                                <i th:case="'그루밍 서비스'" class="fa-solid fa-scissors"></i>
                                <i th:case="'프리미엄 식사'" class="fa-solid fa-utensils"></i>
                                <i th:case="'훈련 프로그램'" class="fa-solid fa-dog"></i>
                                <i th:case="'사진 촬영'" class="fa-solid fa-camera"></i>
                                <i th:case="*"></i>
                            </span>
                            <span class="service-name" th:text="${service.serviceName}"></span>
                        </div>
                        <small class="service-price" th:text="'+' + ${service.servicePrice} + '원'"></small>
                    </div>

                    <div class="service-bottom">
                        <p class="service-desc" th:text="${service.description}"></p>
                        <input type="checkbox" class="service-checkbox" 
                            th:value="${service.servicePrice}" 
                            th:data-name="${service.serviceName}">
                    </div>
                </div>
            </li>
        </ul>
    </div>

    <div class="payment-summary">
        <div class="summary-title">예약 요약</div>

        <div class="summary-row">
            <span>기간</span>
            <span id="summary-date">-</span>
        </div>

        <div class="summary-row">
            <span>객실 요금 (1박)</span>
            <span id="summary-room">0원</span>
        </div>

        <div class="summary-row">
            <span>선택 서비스</span>
            <span id="summary-service">0원</span>
        </div>

        <div class="summary-divider"></div>

        <div class="summary-row total">
            <span>총 결제 금액</span>
            <span id="summary-total">0원</span>
        </div>

        <form id="reservationForm" th:action="@{'/pet/reservation/confirm/' + ${room.roomNo}}" method="post">
            <input type="hidden" name="checkin" id="form-checkin">
            <input type="hidden" name="checkout" id="form-checkout">
            <input type="hidden" name="nights" id="form-nights">
            <input type="hidden" name="total" id="form-total">
            <button type="submit" id="reserveBtn" class="summary-btn">예약하기</button>
        </form>
    </div>

</div>

<th:block th:replace="~{fragments/footer::footer}"></th:block>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener("DOMContentLoaded", function(){
    let rawRoomPrice = parseInt(document.getElementById('room-price').textContent);
    document.getElementById('room-price').textContent = rawRoomPrice.toLocaleString();

    const nightEl = document.getElementById("night-count");
    const serviceCheckboxes = document.querySelectorAll(".service-checkbox");
    const serviceCards = document.querySelectorAll(".service-card");

    const today = new Date();
    today.setHours(0,0,0,0);

    function isPastDate(date){
        const d = new Date(date);
        d.setHours(0,0,0,0);
        return d < today;
    }

    const checkoutInput = flatpickr("#checkout-date", { 
        inline:true, 
        disable:[isPastDate], 
        onChange:function(selectedDates){
            console.log("체크아웃 변경:", selectedDates[0]);
            updateSummary();
        }
    });

    const checkinInput = flatpickr("#checkin-date", { 
        inline:true, 
        disable:[isPastDate], 
        onChange:function(selectedDates){
            console.log("체크인 변경:", selectedDates[0]);
            if(selectedDates.length > 0){
                const checkinDate = selectedDates[0];
                const minCheckout = new Date(checkinDate.getTime());
                minCheckout.setDate(minCheckout.getDate() + 1);
                checkoutInput.set('minDate', minCheckout);
            }
            updateSummary();
        }
    });

    function formatDate(d){
        return d.getFullYear() + "." + String(d.getMonth()+1).padStart(2,"0") + "." + String(d.getDate()).padStart(2,"0");
    }

    function formatLocalDate(date){
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function updateSummary(){
        const checkin = checkinInput.selectedDates[0];
        const checkout = checkoutInput.selectedDates[0];

        console.log("=== updateSummary 호출 ===");
        console.log("체크인:", checkin);
        console.log("체크아웃:", checkout);

        let nights = 0;
        if(checkin && checkout && checkout > checkin){
            nights = Math.ceil((checkout - checkin)/(1000*60*60*24));
        }

        let roomTotal = nights * rawRoomPrice;

        let serviceTotal = 0;
        serviceCheckboxes.forEach(cb => { if(cb.checked) serviceTotal += parseInt(cb.value); });

        nightEl.textContent = nights;
        document.getElementById("summary-date").textContent = checkin && checkout ? formatDate(checkin) + " ~ " + formatDate(checkout) : "-";
        document.getElementById("summary-room").textContent = roomTotal.toLocaleString() + "원";
        document.getElementById("summary-service").textContent = serviceTotal.toLocaleString() + "원";
        document.getElementById("summary-total").textContent = (roomTotal + serviceTotal).toLocaleString() + "원";

        if(checkin) document.getElementById("form-checkin").value = formatLocalDate(checkin);
        if(checkout) document.getElementById("form-checkout").value = formatLocalDate(checkout);
        document.getElementById("form-nights").value = nights;
        document.getElementById("form-total").value = roomTotal + serviceTotal;

        console.log("폼 체크인 값:", document.getElementById("form-checkin").value);
        console.log("폼 체크아웃 값:", document.getElementById("form-checkout").value);
    }

    serviceCheckboxes.forEach(cb => {
        cb.addEventListener("change", function(){
            const card = this.closest('.service-card');
            card.classList.toggle('selected', this.checked);
            updateSummary();
        });
    });

    serviceCards.forEach(card => {
        const checkbox = card.querySelector('.service-checkbox');
        card.addEventListener('click', (e) => {
            if(e.target !== checkbox){
                checkbox.checked = !checkbox.checked;
            }
            card.classList.toggle('selected', checkbox.checked);
            updateSummary();
        });
    });

    document.getElementById("reservationForm").addEventListener("submit", function(e){
        const checkin = checkinInput.selectedDates[0];
        const checkout = checkoutInput.selectedDates[0];

        console.log("=== 폼 제출 시점 ===");
        console.log("체크인 선택:", checkin);
        console.log("체크아웃 선택:", checkout);

        if(!checkin || !checkout){
            e.preventDefault();
            alert("체크인/체크아웃 날짜를 선택해주세요.");
            return;
        }

        if(checkout <= checkin){
            e.preventDefault();
            alert("체크인/체크아웃 날짜가 올바르지 않습니다.");
            return;
        }

        // ✅ submit 직전 한 번 더 확실하게 설정
        document.getElementById("form-checkin").value = formatLocalDate(checkin);
        document.getElementById("form-checkout").value = formatLocalDate(checkout);
        document.getElementById("form-nights").value = Math.ceil((checkout - checkin)/(1000*60*60*24));
        
        console.log("=== 최종 폼 값 ===");
        console.log("최종 체크인:", document.getElementById("form-checkin").value);
        console.log("최종 체크아웃:", document.getElementById("form-checkout").value);
        console.log("최종 박수:", document.getElementById("form-nights").value);
    });
});
</script>



</body>
</html>