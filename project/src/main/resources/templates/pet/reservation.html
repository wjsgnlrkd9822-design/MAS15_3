<!doctype html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê°ì‹¤ ë¦¬ìŠ¤íŠ¸</title>

  <th:block th:replace="~{fragments/linkreservation::link}"></th:block>
  <th:block th:replace="~{fragments/link::link}"></th:block>
  <link rel="stylesheet" th:href="@{/css/reservation.css}"/>
</head>

<body>
<div class="page-bg"></div>

<th:block th:replace="~{fragments/header::header}"></th:block>

<p class="reservation-text">Room List</p>

<!-- â­ ì‚¬ì´ë“œë°” ë ˆì´ì•„ì›ƒ: ì™¼ìª½ í•„í„° + ì˜¤ë¥¸ìª½ ë¦¬ìŠ¤íŠ¸ -->
<div class="search-and-results-container">
  
  <!-- ì™¼ìª½: ê²€ìƒ‰ í•„í„° ì‚¬ì´ë“œë°” -->
  <aside class="integrated-search-section">
    <div class="search-title">ê°ì‹¤ ê²€ìƒ‰</div>
    
    <div class="search-form-container">
      <!-- 1ì¤„: ì²´í¬ì¸ -->
      <div class="date-row">
        <div class="filter-group-integrated">
          <label class="group-label">ì²´í¬ì¸</label>
          <input 
            type="date" 
            id="search-checkin" 
            class="date-input-integrated"
            name="checkin">
        </div>
        
        <!-- 2ì¤„: ì²´í¬ì•„ì›ƒ -->
        <div class="filter-group-integrated">
          <label class="group-label">ì²´í¬ì•„ì›ƒ</label>
          <input 
            type="date" 
            id="search-checkout" 
            class="date-input-integrated"
            name="checkout">
        </div>
      </div>
      
      <!-- 3ì¤„: ê²¬ì¢… -->
      <div class="filter-row">
        <div class="filter-group-integrated">
          <label class="group-label">ê²¬ì¢…</label>
          <div class="chip-container-integrated">
            <label class="filter-chip-integrated">
              <input type="radio" name="sizeType" value="all" checked>
              <span>ì „ì²´</span>
            </label>
            <label class="filter-chip-integrated">
              <input type="radio" name="sizeType" value="ì†Œí˜•ê²¬">
              <span>ì†Œí˜•ê²¬</span>
            </label>
            <label class="filter-chip-integrated">
              <input type="radio" name="sizeType" value="ì¤‘í˜•ê²¬">
              <span>ì¤‘í˜•ê²¬</span>
            </label>
            <label class="filter-chip-integrated">
              <input type="radio" name="sizeType" value="ëŒ€í˜•ê²¬">
              <span>ëŒ€í˜•ê²¬</span>
            </label>
          </div>
        </div>
        
        <!-- 4ì¤„: ê°€ê²© -->
        <div class="filter-group-integrated">
          <label class="group-label">ê°€ê²©</label>
          <div class="chip-container-integrated">
            <label class="filter-chip-integrated">
              <input type="radio" name="sort" value="default" checked>
              <span>ê¸°ë³¸</span>
            </label>
            <label class="filter-chip-integrated">
              <input type="radio" name="sort" value="priceAsc">
              <span>ì €ë ´í•œ ìˆœ</span>
            </label>
            <label class="filter-chip-integrated">
              <input type="radio" name="sort" value="priceDesc">
              <span>ë¹„ì‹¼ ìˆœ</span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- 5ì¤„, 6ì¤„: ë²„íŠ¼ -->
      <div class="search-buttons">
        <button type="button" class="search-btn-integrated" onclick="searchRooms()">
          ê²€ìƒ‰í•˜ê¸°
        </button>
        <button type="button" class="reset-btn-integrated" onclick="resetSearch()">
          ì´ˆê¸°í™”
        </button>
      </div>
    </div>
    
    <!-- ê²°ê³¼ ì¹´ìš´íŠ¸ -->
    <div class="search-result-info" id="result-info" style="display: none;">
      <strong id="result-count">0</strong>
      <div>ê°œì˜ ê°ì‹¤</div>
    </div>
  </aside>

  <!-- ì˜¤ë¥¸ìª½: ê°ì‹¤ ëª©ë¡ -->
  <main class="room-list-section">
    <div class="room-grid" id="room-grid">
      <!-- ì´ˆê¸° ë¡œë”© ì‹œ ì„œë²„ì—ì„œ ë Œë”ë§ëœ ê°ì‹¤ ëª©ë¡ -->
      <a th:each="room : ${rooms}"
         th:href="@{'/pet/reservation/' + ${room.roomNo}}"
         class="reservation-card-link"
         th:data-room-no="${room.roomNo}">

        <div class="reservation-card">
          <!-- ì´ë¯¸ì§€ ì˜ì—­ -->
          <div class="card-image-wrapper">
            <img th:src="@{'/uploads/' + ${room.img}}" class="room-image"/>
            <div class="status-badge available">ì˜ˆì•½ ê°€ëŠ¥</div>
          </div>

          <!-- ë‚´ìš© ì˜ì—­ -->
          <div class="card-content">
            <div class="card-header-row">
              <p class="room-type" th:text="${room.roomType}"></p>
            </div>

            <p class="room-desc" th:text="${room.etc}"></p>

            <div class="card-footer-row">
              <div class="price-box">
                <span class="price-label">1ë°•</span>
                <span class="room-price">
                  <span th:text="${#numbers.formatInteger(room.roomPrice,3,'COMMA')}"></span>
                  <span class="currency">ì›</span>
                </span>
              </div>

              <span class="reserve-btn">ì˜ˆì•½í•˜ê¸°</span>
            </div>
          </div>
        </div>
      </a>
    </div>
  </main>

</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-spinner"></div>
</div>

<th:block th:replace="~{fragments/footer::footer}"></th:block>

<script>
// ===================================
// ì´ˆê¸° ì„¤ì •
// ===================================
const today = new Date().toISOString().split('T')[0];
document.getElementById('search-checkin').setAttribute('min', today);
document.getElementById('search-checkout').setAttribute('min', today);

// ì²´í¬ì¸ ë‚ ì§œ ë³€ê²½ ì‹œ ì²´í¬ì•„ì›ƒ ìµœì†Œ ë‚ ì§œ ì„¤ì •
document.getElementById('search-checkin').addEventListener('change', function() {
  const checkin = this.value;
  if (checkin) {
    const nextDay = new Date(checkin);
    nextDay.setDate(nextDay.getDate() + 1);
    document.getElementById('search-checkout').setAttribute('min', nextDay.toISOString().split('T')[0]);
    
    // ì²´í¬ì•„ì›ƒì´ ì²´í¬ì¸ë³´ë‹¤ ì´ì „ì´ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒë‚ ë¡œ ì„¤ì •
    const checkout = document.getElementById('search-checkout').value;
    if (checkout && new Date(checkout) <= new Date(checkin)) {
      document.getElementById('search-checkout').value = nextDay.toISOString().split('T')[0];
    }
  }
});

// ===================================
// í†µí•© ê²€ìƒ‰ í•¨ìˆ˜
// ===================================
function searchRooms() {
  const checkin = document.getElementById('search-checkin').value;
  const checkout = document.getElementById('search-checkout').value;
  const sizeType = document.querySelector('input[name="sizeType"]:checked').value;
  const sort = document.querySelector('input[name="sort"]:checked').value;
  
  // ë‚ ì§œ ìœ íš¨ì„± ê²€ì‚¬
  if (checkin && checkout) {
    if (new Date(checkout) <= new Date(checkin)) {
      alert('ì²´í¬ì•„ì›ƒ ë‚ ì§œëŠ” ì²´í¬ì¸ ë‚ ì§œë³´ë‹¤ ì´í›„ì—¬ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }
  }
  
  // ë¡œë”© í‘œì‹œ
  showLoading();
  
  // URL íŒŒë¼ë¯¸í„° êµ¬ì„±
  const params = new URLSearchParams();
  if (checkin) params.append('checkin', checkin);
  if (checkout) params.append('checkout', checkout);
  if (sizeType !== 'all') params.append('sizeType', sizeType);
  if (sort !== 'default') params.append('sort', sort);
  
  // AJAX ìš”ì²­
  fetch(`/api/rooms/search?${params.toString()}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('ê²€ìƒ‰ ì‹¤íŒ¨');
      }
      return response.json();
    })
    .then(data => {
      hideLoading();
      
      if (data.success) {
        displayRooms(data.rooms, checkin, checkout);
        showResultCount(data.count);
      } else {
        alert('ê²€ìƒ‰ ì‹¤íŒ¨: ' + data.message);
      }
    })
    .catch(error => {
      hideLoading();
      console.error('Error:', error);
      alert('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ===================================
// ê°ì‹¤ ëª©ë¡ í‘œì‹œ
// ===================================
function displayRooms(rooms, checkin, checkout) {
  const roomGrid = document.getElementById('room-grid');
  
  if (rooms.length === 0) {
    roomGrid.innerHTML = `
      <div class="empty-result">
        <div class="empty-result-icon">ğŸ˜”</div>
        <div class="empty-result-title">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>
        <div class="empty-result-desc">ë‹¤ë¥¸ ì¡°ê±´ìœ¼ë¡œ ê²€ìƒ‰í•´ë³´ì„¸ìš”</div>
      </div>
    `;
    return;
  }
  
  roomGrid.innerHTML = '';
  
  rooms.forEach(room => {
    // URL êµ¬ì„± (ë‚ ì§œê°€ ìˆìœ¼ë©´ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬)
    let url = `/pet/reservation/${room.roomNo}`;
    if (checkin && checkout) {
      url += `?checkin=${checkin}&checkout=${checkout}`;
    }
    
    const roomCard = `
      <a href="${url}" class="reservation-card-link" data-room-no="${room.roomNo}">
        <div class="reservation-card">
          <div class="card-image-wrapper">
            <img src="/uploads/${room.img}" class="room-image" alt="${room.roomType}"/>
            <div class="status-badge available">ì˜ˆì•½ ê°€ëŠ¥</div>
          </div>
          
          <div class="card-content">
            <div class="card-header-row">
              <p class="room-type">${room.roomType}</p>
            </div>
            
            <p class="room-desc">${room.etc || ''}</p>
            
            <div class="card-footer-row">
              <div class="price-box">
                <span class="price-label">1ë°•</span>
                <span class="room-price">
                  <span>${room.roomPrice.toLocaleString()}</span>
                  <span class="currency">ì›</span>
                </span>
              </div>
              
              <span class="reserve-btn">ì˜ˆì•½í•˜ê¸°</span>
            </div>
          </div>
        </div>
      </a>
    `;
    
    roomGrid.innerHTML += roomCard;
  });
}

// ===================================
// ê²°ê³¼ ì¹´ìš´íŠ¸ í‘œì‹œ
// ===================================
function showResultCount(count) {
  const resultInfo = document.getElementById('result-info');
  const resultCount = document.getElementById('result-count');
  
  resultCount.textContent = count;
  resultInfo.style.display = 'block';
}

// ===================================
// ê²€ìƒ‰ ì´ˆê¸°í™”
// ===================================
function resetSearch() {
  // í¼ ì´ˆê¸°í™”
  document.getElementById('search-checkin').value = '';
  document.getElementById('search-checkout').value = '';
  document.querySelector('input[name="sizeType"][value="all"]').checked = true;
  document.querySelector('input[name="sort"][value="default"]').checked = true;
  
  // ê²°ê³¼ ì¹´ìš´íŠ¸ ìˆ¨ê¸°ê¸°
  document.getElementById('result-info').style.display = 'none';
  
  // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ì´ˆê¸° ìƒíƒœë¡œ ë³µì›)
  location.reload();
}

// ===================================
// ë¡œë”© ìƒíƒœ ê´€ë¦¬
// ===================================
function showLoading() {
  document.getElementById('loading-overlay').classList.add('active');
}

function hideLoading() {
  document.getElementById('loading-overlay').classList.remove('active');
}

// ===================================
// URL íŒŒë¼ë¯¸í„°ë¡œ ì´ˆê¸° ê²€ìƒ‰ (ì„ íƒì‚¬í•­)
// ===================================
window.addEventListener('DOMContentLoaded', function() {
  const urlParams = new URLSearchParams(window.location.search);
  
  // URLì— íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ í¼ì— ë°˜ì˜
  const checkin = urlParams.get('checkin');
  const checkout = urlParams.get('checkout');
  const sizeType = urlParams.get('sizeType');
  const sort = urlParams.get('sort');
  
  if (checkin) document.getElementById('search-checkin').value = checkin;
  if (checkout) document.getElementById('search-checkout').value = checkout;
  if (sizeType) {
    const sizeRadio = document.querySelector(`input[name="sizeType"][value="${sizeType}"]`);
    if (sizeRadio) sizeRadio.checked = true;
  }
  if (sort) {
    const sortRadio = document.querySelector(`input[name="sort"][value="${sort}"]`);
    if (sortRadio) sortRadio.checked = true;
  }
});
</script>

</body>
</html>
